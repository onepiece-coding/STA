// after creating a sale, for each sold { productId, qtySold }:
let remainingToDeduct = qtySold;
const supplies = await Supply
  .find({ productId, remainingQty: { $gt: 0 } })
  .sort('expiringAt')
  .exec();

for (let sup of supplies) {
  const take = Math.min(sup.remainingQty, remainingToDeduct);
  sup.remainingQty -= take;
  remainingToDeduct -= take;
  await sup.save();
  if (remainingToDeduct === 0) break;
}
// Finally also decrement product.currentStock by qtySold